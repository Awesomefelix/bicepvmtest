trigger:
  branches:
    include:
      - main

pool:
  name: 'flxbuilder'  # Custom self-hosted agent pool

variables:
  location: 'eastus'
  rgName: 'bicep-vm-rg'
  templateFile: 'main.bicep'
  deploymentName: 'bicepInfraDeployment'

stages:
  - stage: Deploy
    displayName: Deploy Infrastructure
    jobs:
      - job: DeployInfra
        displayName: Deploy Bicep Template to Azure
        steps:
          - checkout: self

          - task: AzureCLI@2
            displayName: 'Deploy Bicep Template'
            inputs:
              azureSubscription: 'FLX'  # Your service connection name
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                echo "=== Starting Bicep Deployment ==="
                echo "Resource Group: $rgName"
                echo "Location: $location"
                echo "Template File: $templateFile"

                # Create resource group if it doesnâ€™t exist
                az group create \
                  --name "$rgName" \
                  --location "$location"

                # Deploy Bicep file
                az deployment group create \
                  --name "$deploymentName" \
                  --resource-group "$rgName" \
                  --template-file "$templateFile" \
                  --parameters \
                    adminUsername='azureuser' \
                    adminPassword='P@ssw0rd1234!' \
                    storagePrefix='bicepstore' \
                    location="$location"

                echo "=== Deployment Completed Successfully ==="
