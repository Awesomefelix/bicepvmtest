trigger:
  branches:
    include:
      - main

pool:
  name: 'flxbuilder'  # Your self-hosted agent pool

variables:
  location: 'eastus'
  rgName: 'bicep-vm-rg'
  templateFile: 'main.bicep'
  deploymentName: 'bicepInfraDeployment'

stages:
  - stage: Deploy
    displayName: Deploy Infrastructure
    jobs:
      - job: DeployInfra
        displayName: Deploy Bicep Template to Azure
        steps:
          - checkout: self

          - task: AzureCLI@2
            displayName: 'Deploy Bicep Template'
            inputs:
              azureSubscription: 'FLX'  # Your service connection name
              scriptType: 'ps'           # Use PowerShell for Windows agent
              scriptLocation: 'inlineScript'
              inlineScript: |
                Write-Host "=== Starting Bicep Deployment ==="
                Write-Host "Resource Group: $env:rgName"
                Write-Host "Location: $env:location"
                Write-Host "Template File: $env:templateFile"

                # Create resource group if it doesnâ€™t exist
                az group create --name $env:rgName --location $env:location

                # Deploy the Bicep template
                az deployment group create `
                  --name $env:deploymentName `
                  --resource-group $env:rgName `
                  --template-file $env:templateFile `
                  --parameters adminUsername='azureuser' adminPassword='P@ssw0rd1234!' `
                               storagePrefix='bicepstore' location=$env:location

                Write-Host "=== Deployment Completed Successfully ==="
