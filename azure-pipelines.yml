trigger:
  branches:
    include:
      - main

pool:
  name: 'flxbuilder'

variables:
  location: 'eastus'
  rgName: 'bicep-vm-rg'
  templateFile: 'main.bicep'

stages:
  - stage: Deploy
    displayName: Deploy Infrastructure
    jobs:
      - job: DeployInfra
        displayName: Deploy Bicep to Azure
        steps:
          - checkout: self

          - task: AzureCLI@2
            displayName: 'Login and Deploy Bicep Template'
            inputs:
              azureSubscription: 'FLX' # name of your service connection
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                echo "Deploying Bicep template..."
                
                az group create --name $rgName --location $location

                az deployment group create \
                  --name "bicepInfraDeployment" \
                  --resource-group $rgName \
                  --template-file $templateFile \
                  --parameters adminUsername='azureuser' adminPassword='P@ssw0rd1234!' \
                                storagePrefix='bicepstore' location=$location
