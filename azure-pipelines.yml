trigger:
  branches:
    include:
      - main

pool:
  name: 'flxbuilder'  # Your self-hosted agent pool

variables:
  location: 'uksouth'
  rgName: 'finaldestinationRG'
  templateFile: 'main.bicep'

stages:
  - stage: Deploy
    displayName: Deploy Infrastructure
    jobs:
      - job: DeployInfra
        displayName: Deploy Bicep Template to Azure
        steps:
          - checkout: self

          - task: AzureCLI@2
            displayName: 'Deploy Bicep Template'
            inputs:
              azureSubscription: 'FLX'
              scriptType: 'ps'
              scriptLocation: 'inlineScript'
              inlineScript: |
                Write-Host "=== Starting Bicep Deployment ==="
                Write-Host "Resource Group: $env:rgName"
                Write-Host "Location: $env:location"
                Write-Host "Template File: $env:templateFile"

                # Generate a unique deployment name
                $deploymentName = "bicepInfraDeployment_$(Get-Date -Format yyyyMMddHHmmss)"
                Write-Host "Deployment Name: $deploymentName"

                try {
                  az deployment sub create `
                    --name $deploymentName `
                    --location $env:location `
                    --template-file $env:templateFile `
                    --parameters rgName=$env:rgName `
                                 storagePrefix='mystorefelixmvpinfl12356' `
                                 adminUsername='azureuser' `
                                 adminPassword='YourSecurePassword123!' `
                    --verbose --debug

                  Write-Host "✅ Deployment Completed Successfully ==="
                }
                catch {
                  Write-Host "❌ Deployment failed. See details below:" -ForegroundColor Red
                  Write-Host $_.Exception.Message
                  exit 1
                }
